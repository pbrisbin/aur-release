#!/bin/sh
set -e

usage() {
  echo "TODO"
}

clone_aur() {
  name=$1
  aur_repo=ssh://aur@aur.archlinux.org/$name

  tmp=$(mktemp -d)
  trap 'rm -rf $tmp' EXIT

  git clone "$aur_repo" "$tmp"
  cd "$tmp"
}

create_aur_if_necessary() {
  name=$1
  aur_repo=ssh://aur@aur.archlinux.org/$name

  if ! git remote -v | grep -Fq aur.archlinux.org; then
    git remote add aur "$aur_repo"
    git fetch aur
    git branch --set-upstream-to=aur/master
  fi
}

update_pkgbuild_version() {
  version=$1
  version=${version#v} # strip v if present
  sed -i "s/^pkgver=.*$/pkgver=$version/" PKGBUILD
  sed -i "s/^pkgrel=.*$/pkgrel=1/" PKGBUILD
}

launch_editor() {
  cmd=$1

  if ! "$cmd"; then
    echo "$cmd returned non-zero" >&2
    exit 1
  fi
}

edit=0
confirm=1
cmd=$SHELL
install=1

while getopts heyC:n opt; do
  case "$opt" in
    h)
      usage
      exit 0
      ;;
    e) edit=1 ;;
    y) confirm=0 ;;
    C) cmd=$OPTARG ;;
    n) install=0 ;;
    [?])
      usage >&2
      exit 64
      ;;
  esac
done
shift $((OPTIND - 1))

name=$1
version=$2

if [ -n "$name" ]; then
  echo "Releasing ${version:-new version} in AUR repository for $name"
  clone_aur "$name"

  if [ -n "$version" ]; then
    echo "Setting PKGBUILD version to $version"
    update_pkgbuild_version "$version"
  fi

  if [ -z "$version" ] || [ "$edit" -eq 1 ]; then
    echo "Launching $cmd in AUR package repo"
    launch_editor "$cmd"
  fi
else
  name="$(basename "$PWD")"
  echo "Releasing this directory as an AUR repository for $name"
  create_aur_if_necessary "$name"

  if [ "$edit" -eq 1 ]; then
    echo "Launching $cmd in AUR package repo"
    launch_editor "$cmd"
  fi
fi

updpkgsums
makepkg --printsrcinfo >.SRCINFO

if [ "$install" -eq 1 ]; then
  echo "Performing test installation..."
  makepkg --syncdeps --install --force
fi

git add .SRCINFO PKGBUILD
git diff --cached

if [ "$confirm" -eq 1 ]; then
  printf "Continue? [y/n] "
  read -r ans
  [ "$ans" != y ] && exit 1
fi

if [ -n "$version" ]; then
  git commit -m "Release v$version"
else
  git commit
fi

git push
