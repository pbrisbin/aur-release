#!/bin/sh
set -e

if [ -z "$1" ]; then
  echo "usage: release VERSION [NAME]" >&2
  exit 64
fi

# support "v1.2.3" for releasing 1.2.3
version=$(echo "$1" | sed 's/^v//')
package=${2:-$(basename "$PWD")}
src_repo=$PWD
tmp_repo=$(mktemp -d)/$package

printf "Releasing %s-%s...\n" "$package" "$version"

if git tag | grep -Fxq "v$version"; then
  echo "tag v$version exists"
else
  git tag -s -m "v$version" "v$version"
  git push --tags
fi

git clone "ssh://aur@aur.archlinux.org/$package" "$tmp_repo"

(
  cd "$tmp_repo"

  if [ ! -f PKGBUILD ]; then
    echo "No PKGBUILD present. Using source repository's..."
    cp -v "$src_repo"/PKGBUILD .
  fi

  sed -i "
    s/^pkgver=.*$/pkgver=$version/; s/=v/=/;
    s/^pkgrel=.*$/pkgrel=1/;" PKGBUILD

  updpkgsums
  mksrcinfo

  git add .SRCINFO PKGBUILD
  git commit -m "Release v$version"
  git push
)

rm -rf "$tmp_repo"
